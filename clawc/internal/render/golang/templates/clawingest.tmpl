// DO NOT EDIT
// This package is autogenerated and should not be modified except by the clawc compiler.

package {{ .File.Package }}

import (
    "context"
    "fmt"
    "iter"

    "github.com/bearlytools/claw/clawc/languages/go/clawiter"
    "github.com/bearlytools/claw/clawc/languages/go/field"
    {{- range .File.ExternalFieldImports }}
    "{{ $.Config.TransformImportPath . }}"
    {{- end }}
)

// Ensure imports are used.
var _ context.Context
var _ = fmt.Errorf
var _ = field.FTBool

{{- $file := .File }}

{{ range $structIndex, $struct := .File.Structs }}
// IngestWithOptions populates the struct from a token stream with options.
// This is the inverse of Walk().
func (x *{{ $struct.Name }}) IngestWithOptions(ctx context.Context, tokens iter.Seq[clawiter.Token], opts clawiter.IngestOptions) error {
    ts := clawiter.NewTokenStream(tokens)
    defer ts.Close()
    return x.XXXIngestFrom(ctx, ts, opts)
}

// XXXIngestFrom is for internal use - ingests from a shared token stream.
func (x *{{ $struct.Name }}) XXXIngestFrom(ctx context.Context, ts *clawiter.TokenStream, opts clawiter.IngestOptions) error {
    tok, ok := ts.Next()
    if !ok {
        return fmt.Errorf("expected TokenStructStart, got EOF")
    }
    if tok.Kind != clawiter.TokenStructStart {
        return fmt.Errorf("expected TokenStructStart, got %v", tok.Kind)
    }

    for {
        tok, ok = ts.Next()
        if !ok {
            return fmt.Errorf("unexpected EOF in {{ $struct.Name }}")
        }

        if tok.Kind == clawiter.TokenStructEnd {
            return nil
        }

        if tok.Kind != clawiter.TokenField {
            return fmt.Errorf("expected TokenField, got %v", tok.Kind)
        }

        switch tok.Name {
        {{- range $fieldIndex, $field := $struct.Fields }}
        case "{{ $field.Name }}":
            {{- if eq $field.TypeAsString "Bool" }}
            x.Set{{ $field.Name }}(tok.Bool())
            {{- else if eq $field.TypeAsString "Int8" }}
            x.Set{{ $field.Name }}(tok.Int8())
            {{- else if eq $field.TypeAsString "Int16" }}
            x.Set{{ $field.Name }}(tok.Int16())
            {{- else if eq $field.TypeAsString "Int32" }}
            x.Set{{ $field.Name }}(tok.Int32())
            {{- else if eq $field.TypeAsString "Int64" }}
            x.Set{{ $field.Name }}(tok.Int64())
            {{- else if eq $field.TypeAsString "Uint8" }}
            {{- if $field.IsEnum }}
            if len(tok.Bytes) > 0 {
                x.Set{{ $field.Name }}({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}ByName[tok.String()])
            } else {
                x.Set{{ $field.Name }}({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}(tok.Uint8()))
            }
            {{- else }}
            x.Set{{ $field.Name }}(tok.Uint8())
            {{- end }}
            {{- else if eq $field.TypeAsString "Uint16" }}
            {{- if $field.IsEnum }}
            if len(tok.Bytes) > 0 {
                x.Set{{ $field.Name }}({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}ByName[tok.String()])
            } else {
                x.Set{{ $field.Name }}({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}(tok.Uint16()))
            }
            {{- else }}
            x.Set{{ $field.Name }}(tok.Uint16())
            {{- end }}
            {{- else if eq $field.TypeAsString "Uint32" }}
            x.Set{{ $field.Name }}(tok.Uint32())
            {{- else if eq $field.TypeAsString "Uint64" }}
            x.Set{{ $field.Name }}(tok.Uint64())
            {{- else if eq $field.TypeAsString "Float32" }}
            x.Set{{ $field.Name }}(tok.Float32())
            {{- else if eq $field.TypeAsString "Float64" }}
            x.Set{{ $field.Name }}(tok.Float64())
            {{- else if eq $field.TypeAsString "String" }}
            x.Set{{ $field.Name }}(tok.String())
            {{- else if eq $field.TypeAsString "Bytes" }}
            x.Set{{ $field.Name }}(tok.Bytes)
            {{- else if eq $field.TypeAsString "Struct" }}
            if tok.IsNil {
                continue
            }
            nested := {{ if $field.IsExternal }}{{ $field.Package }}.New{{ $field.IdentInFile }}(ctx){{ else }}New{{ $field.IdentInFile }}(ctx){{ end }}
            if err := nested.XXXIngestFrom(ctx, ts, opts); err != nil {
                return fmt.Errorf("ingesting {{ $field.Name }}: %w", err)
            }
            x.Set{{ $field.Name }}(nested)
            {{- else if eq $field.TypeAsString "ListBools" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            boolsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                boolsList.Append(itemTok.Bool())
            }
            {{- else if eq $field.TypeAsString "ListInt8" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Int8())
            }
            {{- else if eq $field.TypeAsString "ListInt16" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Int16())
            }
            {{- else if eq $field.TypeAsString "ListInt32" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Int32())
            }
            {{- else if eq $field.TypeAsString "ListInt64" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Int64())
            }
            {{- else if eq $field.TypeAsString "ListUint8" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            {{- if $field.IsEnum }}
            enumsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                if len(itemTok.Bytes) > 0 {
                    enumsList.Append({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}ByName[itemTok.String()])
                } else {
                    enumsList.Append({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}(itemTok.Uint8()))
                }
            }
            {{- else }}
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Uint8())
            }
            {{- end }}
            {{- else if eq $field.TypeAsString "ListUint16" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            {{- if $field.IsEnum }}
            enumsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                if len(itemTok.Bytes) > 0 {
                    enumsList.Append({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}ByName[itemTok.String()])
                } else {
                    enumsList.Append({{ if $field.IsExternal }}{{ $field.Package }}.{{ end }}{{ $field.IdentInFile }}(itemTok.Uint16()))
                }
            }
            {{- else }}
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Uint16())
            }
            {{- end }}
            {{- else if eq $field.TypeAsString "ListUint32" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Uint32())
            }
            {{- else if eq $field.TypeAsString "ListUint64" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Uint64())
            }
            {{- else if eq $field.TypeAsString "ListFloat32" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Float32())
            }
            {{- else if eq $field.TypeAsString "ListFloat64" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            numsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                numsList.Append(itemTok.Float64())
            }
            {{- else if eq $field.TypeAsString "ListBytes" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            bytesList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                bytesList.Append(itemTok.Bytes)
            }
            {{- else if eq $field.TypeAsString "ListStrings" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            strsList := x.{{ $field.Name }}()
            for {
                itemTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if itemTok.Kind == clawiter.TokenListEnd {
                    break
                }
                strsList.Append(itemTok.String())
            }
            {{- else if eq $field.TypeAsString "ListStructs" }}
            if tok.IsNil {
                continue
            }
            listTok, ok := ts.Next()
            if !ok || listTok.Kind != clawiter.TokenListStart {
                return fmt.Errorf("expected TokenListStart for {{ $field.Name }}")
            }
            for {
                peekTok, ok := ts.Peek()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} list")
                }
                if peekTok.Kind == clawiter.TokenListEnd {
                    ts.Next() // consume the ListEnd
                    break
                }
                item := {{ if $field.IsExternal }}{{ $field.Package }}.New{{ $field.IdentInFile }}(ctx){{ else }}New{{ $field.IdentInFile }}(ctx){{ end }}
                if err := item.XXXIngestFrom(ctx, ts, opts); err != nil {
                    return fmt.Errorf("ingesting {{ $field.Name }}[]: %w", err)
                }
                x.{{ $field.Name }}Append(ctx, item)
            }
            {{- else if eq $field.TypeAsString "Map" }}
            if tok.IsNil {
                continue
            }
            mapStartTok, ok := ts.Next()
            if !ok || mapStartTok.Kind != clawiter.TokenMapStart {
                return fmt.Errorf("expected TokenMapStart for {{ $field.Name }}")
            }
            m := x.{{ $field.Name }}Map()
            for {
                entryTok, ok := ts.Next()
                if !ok {
                    return fmt.Errorf("unexpected EOF in {{ $field.Name }} map")
                }
                if entryTok.Kind == clawiter.TokenMapEnd {
                    break
                }
                if entryTok.Kind != clawiter.TokenMapEntry {
                    return fmt.Errorf("expected TokenMapEntry for {{ $field.Name }}, got %v", entryTok.Kind)
                }
                // Get the key
                {{- if eq $field.KeyTypeConst "FTString" }}
                key := entryTok.KeyString()
                {{- else if eq $field.KeyTypeConst "FTBool" }}
                key := entryTok.KeyBool()
                {{- else if eq $field.KeyTypeConst "FTInt8" }}
                key := entryTok.KeyInt8()
                {{- else if eq $field.KeyTypeConst "FTInt16" }}
                key := entryTok.KeyInt16()
                {{- else if eq $field.KeyTypeConst "FTInt32" }}
                key := entryTok.KeyInt32()
                {{- else if eq $field.KeyTypeConst "FTInt64" }}
                key := entryTok.KeyInt64()
                {{- else if eq $field.KeyTypeConst "FTUint8" }}
                key := entryTok.KeyUint8()
                {{- else if eq $field.KeyTypeConst "FTUint16" }}
                key := entryTok.KeyUint16()
                {{- else if eq $field.KeyTypeConst "FTUint32" }}
                key := entryTok.KeyUint32()
                {{- else if eq $field.KeyTypeConst "FTUint64" }}
                key := entryTok.KeyUint64()
                {{- else if eq $field.KeyTypeConst "FTFloat32" }}
                key := entryTok.KeyFloat32()
                {{- else if eq $field.KeyTypeConst "FTFloat64" }}
                key := entryTok.KeyFloat64()
                {{- end }}
                // Get the value
                {{- if $field.ValueIdentName }}
                // Struct value - ingest from following struct tokens
                value := {{ if $field.ValueIsExternal }}{{ $field.ValuePackage }}.New{{ $field.ValueIdentName }}(ctx){{ else }}New{{ $field.ValueIdentName }}(ctx){{ end }}
                if err := value.XXXIngestFrom(ctx, ts, opts); err != nil {
                    return fmt.Errorf("ingesting {{ $field.Name }}[%v]: %w", key, err)
                }
                m.Set(key, value.XXXGetStruct())
                {{- else if eq $field.ValueTypeConst "FTString" }}
                m.Set(key, entryTok.String())
                {{- else if eq $field.ValueTypeConst "FTBool" }}
                m.Set(key, entryTok.Bool())
                {{- else if eq $field.ValueTypeConst "FTInt8" }}
                m.Set(key, entryTok.Int8())
                {{- else if eq $field.ValueTypeConst "FTInt16" }}
                m.Set(key, entryTok.Int16())
                {{- else if eq $field.ValueTypeConst "FTInt32" }}
                m.Set(key, entryTok.Int32())
                {{- else if eq $field.ValueTypeConst "FTInt64" }}
                m.Set(key, entryTok.Int64())
                {{- else if eq $field.ValueTypeConst "FTUint8" }}
                m.Set(key, entryTok.Uint8())
                {{- else if eq $field.ValueTypeConst "FTUint16" }}
                m.Set(key, entryTok.Uint16())
                {{- else if eq $field.ValueTypeConst "FTUint32" }}
                m.Set(key, entryTok.Uint32())
                {{- else if eq $field.ValueTypeConst "FTUint64" }}
                m.Set(key, entryTok.Uint64())
                {{- else if eq $field.ValueTypeConst "FTFloat32" }}
                m.Set(key, entryTok.Float32())
                {{- else if eq $field.ValueTypeConst "FTFloat64" }}
                m.Set(key, entryTok.Float64())
                {{- end }}
            }
            {{- end }}
        {{- end }}
        default:
            if opts.IgnoreUnknownFields {
                if err := clawiter.SkipValue(ts, tok); err != nil {
                    return err
                }
                continue
            }
            return fmt.Errorf("unknown field: %s", tok.Name)
        }
    }
}
{{ end }}
